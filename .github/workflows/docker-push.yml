# publish linux/arm64 and linux/amd64 to ghcr.io/cosmos
name: Create and publish images
on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+" # Push events to matching v*, i.e. v1.0, v20.15.10
jobs:
  build-and-push-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3.1.0
      - uses: actions/setup-go@v3
        with:
          go-version: 1.18
          check-latest: true
      - uses: imjasonh/setup-ko@v0.6
      - run: ko version
      - name: set tag env
        run: echo "VERSION=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV
      - name: Build and push image
        working-directory: ./
        env:
          KO_DOCKER_REPO: ghcr.io/${{ github.repository }}
          COSIGN_EXPERIMENTAL: 'true'
        run: |
          echo "${{ github.token }}" | ko login ghcr.io --username "${{ github.actor }}" --password-stdin
          img=$(ko build ./cmd/gaiad -B --platform linux/amd64,linux/arm64 -t ${{ env.VERSION }}  -t ${{ github.sha }})
          echo "built ${img}"
